# Chapter 7: åŸºç¡€ç®—å­

åœ¨[ç¬¬å…­ç« ](06_çŠ¶æ€ç®¡ç†å™¨_.md)ä¸­ï¼Œæˆ‘ä»¬è®¤è¯†äº†ç³»ç»Ÿçš„"è®°å¿†ç®¡å®¶"ã€‚ç°åœ¨è®©æˆ‘ä»¬å›åˆ°æœ€åŸºç¡€çš„æ„å»ºå•å…ƒâ€”â€”å°±åƒä¹é«˜ç§¯æœ¨ä¸­æœ€åŸºç¡€çš„å°æ–¹å—ä¸€æ ·ï¼Œ**åŸºç¡€ç®—å­**æ˜¯æ•´ä¸ªç³»ç»Ÿä¸­æœ€åº•å±‚çš„"å·¥äºº"ï¼Œæ‰€æœ‰å¤æ‚åŠŸèƒ½éƒ½ç”±å®ƒä»¬ç»„åˆè€Œæˆã€‚

## ä¸ºä»€ä¹ˆéœ€è¦åŸºç¡€ç®—å­ï¼Ÿ

æƒ³è±¡ä¸€ä¸ªæŠ«è¨åº—çš„å¨æˆ¿ï¼š
- åˆ‡èœå¸ˆå‚…ï¼ˆæ•°æ®å‡†å¤‡ï¼‰
- çƒ¤ç‚‰å¸ˆå‚…ï¼ˆæ•°æ®å¤„ç†ï¼‰
- è£…ç›’å¸ˆå‚…ï¼ˆç»“æœè¾“å‡ºï¼‰

åŸºç¡€ç®—å­å°±æ˜¯è¿™äº›"ä¸“ä¸šå¸ˆå‚…"çš„æ ‡å‡†å·¥ä½œå°ï¼Œå®ƒè§„å®šäº†ï¼š
```mermaid
pie
    title ç®—å­ä¸‰å¤§èŒè´£
    "å¤„ç†æ•°æ®" : 60
    "åˆå§‹åŒ–å‡†å¤‡" : 20
    "æ¸…ç†ç°åœº" : 20
```

## åˆè¯†åŸºç¡€ç®—å­

æ‰“å¼€`core/operators/base/operator.py`ï¼Œå¯ä»¥çœ‹åˆ°è¿™æ˜¯æ‰€æœ‰ç®—å­çš„"èº«ä»½è¯"ï¼š

```python
class Operator:
    """æ‰€æœ‰å·¥äººçš„æ ‡å‡†åŒ–åˆåŒ"""
    async def process(self, input_data):
        raise NotImplementedError("æ¯ä¸ªå·¥äººå¿…é¡»ä¼šå¹²æ´»ï¼")  # æ ¸å¿ƒæŠ€èƒ½
    
    async def setup(self): pass  # ä¸Šç­å‰çš„å‡†å¤‡å·¥ä½œ
    async def cleanup(self): pass  # ä¸‹ç­å‰çš„æ‰“æ‰«
```

### æœ€ç®€å•çš„ä¾‹å­
```python
class åˆ‡èœå¸ˆå‚…(Operator):
    async def process(self, è”¬èœ):
        return åˆ‡å¥½çš„è”¬èœ = [è”¬èœåˆ‡æˆç‰‡]
```

## æ ¸å¿ƒæ¦‚å¿µè§£æ

### 1. ç®—å­çŠ¶æ€
æ¯ä¸ªå·¥äººéƒ½æœ‰å·¥ä½œçŠ¶æ€ç‰Œï¼š
```python
class OperatorStatus(Enum):
    PENDING = "ç­‰å¾…ä¸­"   # æ­£åœ¨ç­‰æ´»å„¿
    RUNNING = "å·¥ä½œä¸­"   # æ­£åœ¨åˆ‡èœ
    COMPLETED = "å·²å®Œæˆ" # æ´»å„¿å¹²å®Œäº†
    FAILED = "æç ¸äº†"    # åˆ‡åˆ°æ‰‹äº†...
```

### 2. å¤„ç†æµç¨‹
æ ‡å‡†å·¥ä½œä¸‰æ­¥èµ°ï¼š
```mermaid
sequenceDiagram
    ç”¨æˆ·->>ç®—å­: åˆ†é…ä»»åŠ¡(setup)
    ç®—å­->>ç”¨æˆ·: å‡†å¤‡å°±ç»ª
    ç”¨æˆ·->>ç®—å­: å¼€å§‹å¹²æ´»(process)
    ç®—å­->>ç”¨æˆ·: äº¤ä»˜æˆæœ
    ç”¨æˆ·->>ç®—å­: æ”¶æ‹¾å·¥å…·(cleanup)
```

### 3. ç®—å­èŠ‚ç‚¹
DAGæµæ°´çº¿ä¸­çš„"å·¥ä½"ï¼š
```python
@dataclass
class OperatorNode:
    operator: Operator    # å·¥äººæœ¬ä½“
    name: str             # å·¥ç‰Œåå­—
    dependencies: Set[str] # éœ€è¦ç­‰å“ªäº›åŒäº‹å…ˆå®Œæˆ
```

## å¦‚ä½•åˆ›å»ºè‡ªå®šä¹‰ç®—å­

### åŸºç¡€æ¨¡æ¿
```python
from daily_paper.core.operators import Operator

class æˆ‘çš„ç®—å­(Operator):
    def __init__(self, å‚æ•°):
        self.å·¥å…· = å‚æ•°  # åˆå§‹åŒ–è‡ªå¤‡å·¥å…·
    
    async def process(self, è¾“å…¥æ•°æ®):
        return è¾“å…¥æ•°æ® + "å¤„ç†åçš„ç»“æœ"
```

### å®Œæ•´ç”Ÿå‘½å‘¨æœŸç¤ºä¾‹
```python
class å’–å•¡æœº(Operator):
    async def setup(self):
        print("æ³¨å…¥æ¸…æ°´ï¼Œé¢„çƒ­æœºå™¨")  # ä¸Šç­å‡†å¤‡
    
    async def process(self, å’–å•¡è±†):
        return f"{å’–å•¡è±†}å˜æˆé¦™æµ“å’–å•¡"
    
    async def cleanup(self):
        print("æ¸…ç†å’–å•¡æ¸£ï¼Œå…³æœº")  # ä¸‹ç­æ”¶æ‹¾
```

## å†…éƒ¨å·¥ä½œæ­ç§˜

å½“ç®—å­è¢«è°ƒç”¨æ—¶ï¼š
1. **åˆå§‹åŒ–é˜¶æ®µ**ï¼šæ‰§è¡Œsetup()
   ```python
   # åœ¨DAGæµæ°´çº¿ä¸­è°ƒç”¨
   await operator.setup()  # å‡†å¤‡åŸæ–™
   ```

2. **å¤„ç†é˜¶æ®µ**ï¼šæ ¸å¿ƒå·¥ä½œ
   ```python
   try:
       result = await operator.process(data)  # å®é™…åŠ å·¥
       status = OperatorStatus.COMPLETED
   except:
       status = OperatorStatus.FAILED
   ```

3. **æ¸…ç†é˜¶æ®µ**ï¼šèµ„æºé‡Šæ”¾
   ```python
   finally:
       await operator.cleanup()  # æ— è®ºå¦‚ä½•éƒ½ä¼šæ‰§è¡Œ
   ```

## å®æˆ˜ï¼šæ„å»ºè®¡æ•°ç®—å­

è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç»Ÿè®¡è®ºæ–‡æ•°é‡çš„ç®—å­ï¼š
```python
class è®ºæ–‡è®¡æ•°å™¨(Operator):
    async def process(self, è®ºæ–‡åˆ—è¡¨):
        return {
            "æ€»ç¯‡æ•°": len(è®ºæ–‡åˆ—è¡¨),
            "æœ€æ—©æ—¥æœŸ": min(p.date for p in è®ºæ–‡åˆ—è¡¨)
        }
```

åœ¨æµæ°´çº¿ä¸­ä½¿ç”¨ï¼š
```python
pipeline.add_operator("ç»Ÿè®¡", è®ºæ–‡è®¡æ•°å™¨())
```

## ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

- ğŸ§© **ç»Ÿä¸€æ¥å£**ï¼šæ‰€æœ‰ç®—å­å…¼å®¹DAGè°ƒåº¦
- â±ï¸ **ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼šè§„èŒƒèµ„æºä½¿ç”¨
- ğŸ”„ **å¹‚ç­‰æ€§**ï¼šç›¸åŒè¾“å…¥æ°¸è¿œå¾—åˆ°ç›¸åŒè¾“å‡º
- ğŸ§‘â€ğŸ”§ **å¯æ‰©å±•**ï¼šè½»æ¾æ·»åŠ æ–°åŠŸèƒ½ç®—å­

## æ€»ç»“ä¸ä¸‹ä¸€æ­¥

ä»Šå¤©æˆ‘ä»¬æŒæ¡äº†ï¼š
- åŸºç¡€ç®—å­æ˜¯ç³»ç»Ÿçš„"æ ‡å‡†å·¥äºº"
- å¿…é¡»å®ç°process()æ ¸å¿ƒæ–¹æ³•
- é€šè¿‡setup()å’Œcleanup()ç®¡ç†èµ„æº
- åœ¨DAGä¸­ä½œä¸ºèŠ‚ç‚¹è¿ä½œ

åœ¨ä¸‹ä¸€ç« ï¼Œæˆ‘ä»¬å°†äº†è§£ç³»ç»Ÿçš„"æ–‡ä»¶æŸœ"â€”â€”[æœ¬åœ°å­˜å‚¨ç»„ä»¶](08_æœ¬åœ°å­˜å‚¨ç»„ä»¶_.md)ï¼Œå®ƒè´Ÿè´£å®‰å…¨ä¿å­˜æ‰€æœ‰å¤„ç†ç»“æœï¼

---

Generated by [AI Codebase Knowledge Builder](https://github.com/The-Pocket/Tutorial-Codebase-Knowledge)